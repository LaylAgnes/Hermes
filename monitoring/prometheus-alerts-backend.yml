groups:
  - name: hermes-jobs-alerts
    rules:
      - alert: JobsApiDown
        expr: up{job="hermes-jobs"} == 0
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "Hermes Jobs API indisponível"
          description: "O target de scrape do serviço jobs está fora por mais de 3 minutos."

      - alert: JobsSearch5xxHigh
        expr: increase(http_server_requests_seconds_count{job="hermes-jobs",uri="/api/v1/search/filters",status=~"5.."}[10m]) >= 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Erros 5xx elevados em /api/v1/search/filters"
          description: "A API de busca estruturada está apresentando erro 5xx acima do limiar."

      - alert: JobsHighLatencyP95
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{job="hermes-jobs",uri="/api/v1/search/filters"}[5m])) by (le)) > 1.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Latência p95 alta na busca"
          description: "A latência p95 de /api/v1/search/filters passou de 1.2s por 10 minutos."

      - alert: JobsImportRejectedBySourceHigh
        expr: sum by (source, source_type) (increase(hermes_jobs_import_rejected_by_source_total[15m])) >= 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Rejeição de import elevada por source"
          description: "A API rejeitou muitas vagas de uma mesma source na janela de 15 minutos."

  - name: hermes-quality-sli
    rules:
      - record: hermes_quality_source_acceptance_rate_15m
        expr: |
          sum by (source, source_type) (increase(hermes_jobs_import_by_source_total[15m]))
          /
          clamp_min(sum by (source, source_type) (increase(hermes_consumer_received_by_source_total[15m])), 1)

      - alert: HermesSourceAcceptanceRateLow
        expr: hermes_quality_source_acceptance_rate_15m < 0.90
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Acceptance rate baixo por source"
          description: "A source {{ $labels.source }} ({{ $labels.source_type }}) está com acceptance rate < 90% em 15m."
